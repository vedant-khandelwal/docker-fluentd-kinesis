<match fluent.**>
  @type null
</match>

<source>
  @type tail
  path /var/log/containers/*.log
  pos_file /var/log/fluent-containers.log.pos
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  tag kubernetes.*
  format json
  read_from_head true
</source>

<source>
  @type systemd
  tag docker
  path /var/log/journal
  matches [{ "_SYSTEMD_UNIT": "docker.service" }]
  read_from_head true
  <storage>
    @type local
    persistent true
    path /var/log/journal.docker.pos
  </storage>
</source>

<filter kubernetes.**>
  @type kubernetes_metadata
  kubernetes_url "#{ENV["FLUENTD_KUBERNETES_URL"]}"
</filter>

<filter **>
  @type record_transformer
  <record>
    installation "#{ENV["FALKONRY_INSTALLATION_ID"]}"
  </record>
</filter>

<match **>
  type forward
  send_timeout 60s
  recover_wait 10s
  heartbeat_type tcp
  heartbeat_interval 5s
  phi_threshold 16
  hard_timeout 60s
  <server>
    name logging-agent-1
    host "#{ENV['LOGGING_AGENT_HOST']}"
    port "#{ENV['LOGGING_AGENT_PORT']}"
    weight 60
  </server>
  <secondary>
    type file
    path /var/log/fluent/forward-failed
  </secondary>
</match>
